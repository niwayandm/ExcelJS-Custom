/*!
* Custom ExcelJS functions to export Excel with automatic merging.
* 2024 - Devina
*/
function delay(ms){return new Promise(resolve=>setTimeout(resolve,ms))}function getColumnAddress(colNum){let columnAddress="",dividend=colNum,remainder;for(;dividend>0;)remainder=(dividend-1)%26,columnAddress=String.fromCharCode("A".charCodeAt(0)+remainder)+columnAddress,dividend=parseInt((dividend-remainder)/26);return columnAddress}function setCellStyle(htmlCell,excelCell){var bgColor=getComputedStyle(htmlCell).backgroundColor,trimmedValue;if("rgba(0, 0, 0, 0)"!==bgColor&&bgColor.startsWith("rgb(")&&"rgb(255, 255, 255)"!==bgColor){var color=bgColor.match(/\d+/g).map(Number);excelCell.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF"+color.map(c=>c.toString(16).padStart(2,"0")).join("")}},excelCell.font={name:"Arial",size:10,bold:!0}}(excelCell.isMerged&&(excelCell.alignment={vertical:"middle"}),htmlCell.classList.contains("text-center")?excelCell.alignment={horizontal:"center",vertical:"middle"}:htmlCell.classList.contains("text-right")&&(excelCell.alignment={horizontal:"right"}),"string"==typeof excelCell.value)?""===excelCell.value.replace(/\u00a0/g,"").trim()&&"&nbsp;"!==htmlCell.innerHTML.trim()||(excelCell.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}}):"number"==typeof excelCell.value&&(excelCell.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}})}function getColSpan(worksheet,cellAddress,rowNumber){var currentColumn=cellAddress.match(/[A-Z]+/)[0],colSpan=0;do{colSpan++;var nextColumn,nextCellAddress=getColumnAddress(columnToNumber(currentColumn)+colSpan)+rowNumber,nextCell=worksheet.getCell(nextCellAddress)}while(nextCell.isMerged);return colSpan}function getMaxRow(worksheet){var maxRow=0;return worksheet.eachRow((function(row,rowNumber){maxRow=rowNumber})),maxRow}function isTopLeftCellOfMerge(worksheet,cellAddress){var cell=worksheet.getCell(cellAddress);if(!cell.isMerged)return!1;for(var rowNumber=cell.row,columnLetter=cellAddress.match(/[A-Z]+/)[0],i=1;i<columnLetter.length;i++){var prevCellAddress=columnLetter.substring(0,i)+rowNumber,prevCell=worksheet.getCell(prevCellAddress);if(prevCell.isMerged&&cell.master===prevCell.master)return!1}for(var j=rowNumber-1;j>0;j--){var aboveCellAddress=columnLetter+j,aboveCell=worksheet.getCell(aboveCellAddress);if(aboveCell.isMerged&&cell.master===aboveCell.master)return!1}return!0}function columnToNumber(column){let columnNumber=0;for(let i=0;i<column.length;i++)columnNumber*=26,columnNumber+=column.charCodeAt(i)-("A".charCodeAt(0)-1);return columnNumber}function extractTextFromHtml(html){var tempDiv=document.createElement("div"),text;return tempDiv.innerHTML=html.replace(/&nbsp;/g,"Â "),tempDiv.textContent||tempDiv.innerText||""}function exportTableToWorksheet2(tableClassName,worksheet,startRow=0){var tables=document.getElementsByClassName(tableClassName),columnAddressCache={},startColumn=1,columnWidths={};function getCachedColumnAddress(columnNumber){return columnAddressCache[columnNumber]||(columnAddressCache[columnNumber]=getColumnAddress(columnNumber)),columnAddressCache[columnNumber]}function getColumnWidth(text){return 1.75*text.length}for(var i=0;i<tables.length;i++){for(var table,rows=tables[i].rows,maxCols=0,maxRows=0,j=0;j<rows.length;j++){var adjustedRow=j+startRow+maxRows,row=rows[j],currentCell=startColumn,cells=row.cells,localMaxCol=0,excelRow=worksheet.getRow(adjustedRow+1);!row.classList.contains("collapse")||row.classList.contains("SU")||row.classList.contains("PF")?row.classList.contains("PF")&&(excelRow.hidden=!0):(excelRow.outlineLevel=1,row.classList.contains("in")?excelRow.hidden=!1:excelRow.hidden=!0);for(var k=0;k<cells.length;k++){var cell=cells[k],cellValue=cell.innerText||cell.textContent,cellAddress=`${getColumnAddress(currentCell)}${adjustedRow+1}`,excelCell=worksheet.getCell(cellAddress),isTopLeft=isTopLeftCellOfMerge(worksheet,cellAddress);if(excelCell.isMerged&&!isTopLeft){var colSpan=getColSpan(worksheet,cellAddress,adjustedRow+1);adjustedRow-=maxRows,maxRows=0,cellAddress=`${getColumnAddress(currentCell+=colSpan)}${adjustedRow+1}`,excelCell=worksheet.getCell(cellAddress)}var rowSpan=cell.rowSpan||1,colSpan=cell.colSpan||1;if(rowSpan>1||colSpan>1){var mergeStart=cellAddress,mergeEnd=getCachedColumnAddress(currentCell+colSpan-1)+(adjustedRow+rowSpan);worksheet.mergeCells(mergeStart,mergeEnd)}if(cellValue.trim().replace(/,/g,"").endsWith("%")&&!isNaN(cellValue.trim().replace(/,/g,"").replace("%",""))&&cellValue.trim().replace(/,/g,"").replace("%","").length>1?(cellValue=parseFloat(cellValue.trim().replace(/,/g,"").replace("%",""))/100,Number.isInteger(100*cellValue)?excelCell.numFmt="0%":excelCell.numFmt="0.00%"):isNaN(cellValue.trim().replace(/,/g,""))||""===cellValue.trim()||(cellValue=cellValue.trim().replace(/,/g,""),cellValue=parseFloat(cellValue),Number.isInteger(cellValue)?excelCell.numFmt="#,##0":excelCell.numFmt="#,##0.00"),excelCell.value=cellValue,setCellStyle(cell,excelCell),(rowSpan>1||colSpan>1)&&"th"!==cell.tagName.toLowerCase());else if(""!==excelCell.value||!excelCell.isMerged&&!isTopLeft)if(tableClassName.includes("2")&&tableClassName.includes("22"));else{var columnWidth=getColumnWidth(cellValue.toString().replace(/,/g,""));(!columnWidths[currentCell]||columnWidth>=columnWidths[currentCell])&&(columnWidths[currentCell]=columnWidth)}else(!columnWidths[currentCell]||8.3>=columnWidths[currentCell])&&(columnWidths[currentCell]=8.3);currentCell+=colSpan,localMaxCol=Math.max(localMaxCol,currentCell-1)}maxCols=Math.max(maxCols,localMaxCol),String(excelCell.value).includes("TOTAL")?maxRows=0:maxRows+=rowSpan-maxRows>0?rowSpan-1:0}excelRow.commit(),startColumn=localMaxCol+2}for(let columnIndex in columnWidths){var columnLetter=getColumnAddress(parseInt(columnIndex)),column;worksheet.getColumn(columnLetter).width=columnWidths[columnIndex]+2}worksheet.views=[{zoomScale:70}]}async function waitForTableLoad(tableId){return await delay(500),new Promise((resolve,reject)=>{let attempts=0;function checkTable(){const table=document.querySelector(tableId);console.log(table),table&&table.rows.length>0?resolve():attempts<50?(attempts++,setTimeout(checkTable,1e3)):reject(new Error("Table did not load in time."))}checkTable()})}